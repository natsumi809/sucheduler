<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ©ãƒ¼</title>
    <script src='https://cdn.jsdelivr.net/npm/fullcalendar@6.1.10/index.global.min.js'></script>
    <script src='https://cdn.jsdelivr.net/npm/@fullcalendar/google-calendar@6.1.10/index.global.min.js'></script>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; margin: 0; display: flex; height: 100vh; color: #333; }
        .task-list { flex: 2; background-color: #f8f9fa; border-right: 1px solid #ddd; padding: 20px; overflow-y: auto; display: flex; flex-direction: column; }
        .task-item { background: white; margin: 10px 0; padding: 12px; border-radius: 8px; cursor: grab; border-left: 5px solid #007aff; box-shadow: 0 2px 4px rgba(0,0,0,0.05); font-size: 14px; user-select: none; }
        /* å…¥åŠ›ã‚¨ãƒªã‚¢å…¨ä½“ */
        #new-task-area {
            display: none;
            flex-direction: column;
            gap: 8px;
            margin-top: 10px;
        }
        /* ã‚¿ã‚¹ã‚¯åå…¥åŠ› */
        #new-task-input {
            width: 100%;
            padding: 10px;
            border: 1px solid #007aff;
            border-radius: 8px;
            box-sizing: border-box;
            font-size: 14px;
            outline: none;
            display: block; /* ã‚¨ãƒªã‚¢ãŒå‡ºã‚Œã°ã“ã‚Œã‚‚å‡ºã‚‹ */
        }
        /* æ™‚é–“å…¥åŠ›ï¼ˆæœ€åˆã¯éš ã™ï¼‰ */
        #new-task-time {
            display: none;
            width: 100%;
            padding: 10px;
            border: 1px solid #007aff;
            border-radius: 8px;
            box-sizing: border-box;
            font-size: 14px;
            outline: none;
        }
        
        .calendar-area { flex: 8; padding: 20px; }
        #calendar { height: 100%; }
        .fc-day-sat { background-color: #f0f7ff !important; }
        .fc-day-sun { background-color: #fff0f0 !important; }

        #edit-modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.4); }
        .modal-content { background-color: white; margin: 10% auto; padding: 25px; border-radius: 12px; width: 380px; box-shadow: 0 4px 15px rgba(0,0,0,0.2); }
        .field { margin-bottom: 15px; }
        .field label { display: block; font-size: 12px; color: #666; margin-bottom: 5px; }
        .field input { width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 6px; box-sizing: border-box; }
        .modal-buttons { display: flex; justify-content: flex-end; gap: 10px; margin-top: 20px; }
        .btn { padding: 8px 16px; border-radius: 6px; border: none; cursor: pointer; font-size: 14px; }
        .btn-save { background: #007aff; color: white; }
        .btn-cancel { background: #eee; color: #333; }
        #clear-time { width: 40px; border: 1px solid #ddd; border-radius: 6px; background: #f8f9fa; cursor: pointer; font-size: 18px; }
        .color-palette { display: flex; flex-wrap: wrap; gap: 8px; margin-top: 5px; }
        .color-chip { width: 28px; height: 28px; border-radius: 4px; border: 2px solid #eee; cursor: pointer; }
        .color-chip.selected { border-color: #333; transform: scale(1.1); }

        /* ä¸€æ‹¬å‰Šé™¤ãƒœã‚¿ãƒ³ã®ãƒ›ãƒãƒ¼åŠ¹æœ */
        #clear-all-todo:hover { background-color: #ff3b30 !important; color: white !important; }

        /* styleã‚¿ã‚°ã®æœ€å¾Œã®æ–¹ã«è¿½åŠ  */
        .fc-day-sun .fc-col-header-cell-cushion,
        .fc-day-sun .fc-daygrid-day-number { color: #ff3b30; } /* æ—¥æ›œã‚’èµ¤ã */
        .fc-day-sat .fc-col-header-cell-cushion,
        .fc-day-sat .fc-daygrid-day-number { color: #007aff; } /* åœŸæ›œã‚’é’ã */

        /* ç¥æ—¥ã®ã‚¤ãƒ™ãƒ³ãƒˆï¼ˆèƒŒæ™¯ï¼‰ã‚’è–„ã„ãƒ”ãƒ³ã‚¯ã«ã™ã‚‹è¨­å®š */
        .holiday-event {
            background-color: #ffe8e8 !important;
            border: none !important;
            color: #fe3232 !important;
            font-size: 0.85em;
            font-weight: bold;
            pointer-events: none; /* ç¥æ—¥ã¯ã‚¯ãƒªãƒƒã‚¯ã‚„ãƒ‰ãƒ©ãƒƒã‚°ä¸å¯ã«ã™ã‚‹ */
            opacity: 1 !important;
        }

        /* ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼å†…ã®ç¥æ—¥ã‚¿ã‚¤ãƒˆãƒ«ã®é…ç½®èª¿æ•´ï¼ˆä»»æ„ï¼‰ */
        .fc-daygrid-bg-event .fc-event-title {
            padding: 2px 4px !important;
            display: block !important;
        }

        /* ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ãŒåˆ‡ã‚Šæ›¿ã‚ã‚‹ã¨ãã®ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ */
        /* å³ã«é€²ã‚€ã¨ãã®ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ï¼ˆæ–°ã—ã„æœˆãŒå³ã‹ã‚‰æ¥ã‚‹ï¼‰ */
        .slide-in-right {
            animation: slideInRight 0.3s ease-out;
        }
        @keyframes slideInRight {
            from { opacity: 0; transform: translateX(30px); }
            to { opacity: 1; transform: translateX(0); }
        }

        /* å·¦ã«æˆ»ã‚‹ã¨ãã®ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ï¼ˆæ–°ã—ã„æœˆãŒå·¦ã‹ã‚‰æ¥ã‚‹ï¼‰ */
        .slide-in-left {
            animation: slideInLeft 0.3s ease-out;
        }
        @keyframes slideInLeft {
            from { opacity: 0; transform: translateX(-30px); }
            to { opacity: 1; transform: translateX(0); }
        }

        /* å³ã«é€²ã‚€ï¼ˆå³ã‹ã‚‰ã‚¹ãƒ©ã‚¤ãƒ‰ï¼‰ */
        .slide-in-right {
            animation: slideInRight 0.3s ease-out;
        }
        @keyframes slideInRight {
            from { opacity: 0; transform: translateX(30px); }
            to { opacity: 1; transform: translateX(0); }
        }

        /* å·¦ã«æˆ»ã‚‹ï¼ˆå·¦ã‹ã‚‰ã‚¹ãƒ©ã‚¤ãƒ‰ï¼‰ */
        .slide-in-left {
            animation: slideInLeft 0.3s ease-out;
        }
        @keyframes slideInLeft {
            from { opacity: 0; transform: translateX(-30px); }
            to { opacity: 1; transform: translateX(0); }
        }

        /* ä»Šæ—¥ï¼ˆTodayï¼‰ã«æˆ»ã‚‹æ™‚ã®ãµã‚ã£ã¨è¡¨ç¤º */
        .calendar-fade {
            animation: calendarFade 0.4s ease-out;
        }
        @keyframes calendarFade {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        /* å·¦ä¸Šã®ã‚¿ã‚¤ãƒˆãƒ«ã¨Todayãƒœã‚¿ãƒ³ã®ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆèª¿æ•´ */
        .fc-toolbar-chunk {
            display: flex;
            align-items: center;
        }

        .fc .fc-toolbar-title {
            margin-right: 15px; /* ã‚¿ã‚¤ãƒˆãƒ«ã¨ãƒœã‚¿ãƒ³ã®é–“ã®ä½™ç™½ */
            font-size: 1.5rem;   /* æ–‡å­—ã®å¤§ãã•ï¼ˆãŠå¥½ã¿ã§èª¿æ•´ï¼‰ */
        }

        /* Todayãƒœã‚¿ãƒ³ã®ä½™è¨ˆãªãƒãƒ¼ã‚¸ãƒ³ã‚’æ¶ˆã—ã¦é«˜ã•ã‚’åˆã‚ã›ã‚‹ */
        .fc .fc-today-button {
            margin-left: 0 !important;
        }
        .todo-delete-btn {
            transition: background-color 0.3s, transform 0.2s;
            background-color: #8E8E93; /* é¸æŠå‰Šé™¤ã®æ™‚ã¯å°‘ã—æ§ãˆã‚ãªè‰² */
            color: white;
            border: none;
            padding: 5px 10px;
            border-radius: 5px;
            cursor: pointer;
        }

        /* ä¸€æ‹¬å‰Šé™¤ï¼ˆè­¦å‘ŠçŠ¶æ…‹ï¼‰ã®æ™‚ã®è‰² */
        .todo-delete-btn.danger {
            background-color: #FF3B30;
        }
        /* é¸æŠå‰Šé™¤ãƒ¢ãƒ¼ãƒ‰ã§é¸æŠã•ã‚ŒãŸæ™‚ã®èµ¤æ  */
        .task-item.selected-for-delete {
            border: 2px solid #FF3B30 !important;
            box-shadow: 0 0 10px rgba(255, 59, 48, 0.3);
        }

        /* éš ã—ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹ï¼ˆè¡¨ç¤ºã¯ã›ãšã€ãƒ­ã‚¸ãƒƒã‚¯ã¨ã—ã¦ä½¿ç”¨ï¼‰ */
        .todo-checkbox {
            display: none;
        }

        /* å‰Šé™¤ãƒ»æˆ»ã™æ ï¼šã‚¿ã‚¹ã‚¯ä¸€è¦§ã®ç›´ä¸‹ã«è¡¨ç¤ºã•ã›ã‚‹è¨­å®š */
        #return-drop-zone, #delete-drop-zone {
            visibility: hidden; /* display: none ã®ä»£ã‚ã‚Šã«éè¡¨ç¤ºã«ã™ã‚‹ */
            opacity: 0;
            margin-top: 15px; 
            padding: 20px 10px;
            border-radius: 10px; 
            text-align: center; 
            font-weight: bold; 
            font-size: 0.85em; 
            position: relative;
            width: 100%; 
            box-sizing: border-box;
            pointer-events: none; /* éè¡¨ç¤ºæ™‚ã¯åå¿œã•ã›ãªã„ */
            z-index: 10;
        }
        #return-drop-zone { border: 3px dashed #007aff; color: #007aff; background: #eef6ff; }
        #delete-drop-zone { border: 3px dashed #ff3b30; color: #ff3b30; background: #fff2f1; }

    </style>
</head>
<body>
    <div class="task-list" id="external-events-container">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
            <h2 style="margin: 0;">ã‚¿ã‚¹ã‚¯ä¸€è¦§</h2>
            <div id="delete-btn-group" style="display: flex; gap: 5px;">
                <button id="delete-toggle-btn" class="todo-delete-btn">é¸æŠå‰Šé™¤</button>
                <button id="bulk-delete-btn" class="todo-delete-btn" style="display: none; background-color: #8E8E93;">ä¸€æ‹¬å‰Šé™¤</button>
            </div>
        </div>

        <div id="todo-list">
            {% for task in todo_list %}
                <div class='fc-event task-item' 
                    style="border-left-color: {{ task.color }};"
                    data-id="{{ task.id }}" 
                    data-event='{"title": "{{ task.title }}", "id": "{{ task.id }}", "color": "{{ task.color }}", "allDay": {{ task.is_all_day|yesno:"true,false" }}, "time": "{{ task.time|time:"H:i" }}"}'>
                    
                    <input type="checkbox" class="todo-checkbox" data-id="{{ task.id }}">

                    <div style="display: flex; justify-content: space-between; align-items: center; width: 100%;">
                        <span>{{ task.title }}</span>
                        {% if task.time %}
                            <small style="color:#666; font-weight: normal;">{{ task.time|time:"H:i" }}</small>
                        {% endif %}
                    </div>
                </div>
            {% endfor %}
        </div>

        <div id="new-task-area">
            <input type="text" id="new-task-input" placeholder="ã‚¿ã‚¹ã‚¯åã‚’å…¥åŠ›..." style="flex: 3; display: block;">
            <input type="time" id="new-task-time" style="flex: 1; padding: 10px; border: 1px solid #007aff; border-radius: 8px; font-size: 14px; outline: none;">
        </div>
        <div id="return-drop-zone">ã“ã“ã«ãƒ‰ãƒ­ãƒƒãƒ—ã§<br>ä¸€è¦§ã«æˆ»ã™</div>
        <div id="delete-drop-zone">ğŸ—‘ï¸ å‰Šé™¤</div>
    </div>
    

    <div class="calendar-area">
        <div id="calendar"></div>
    </div>

    <div id="edit-modal">
        <div class="modal-content">
            <h3>ã‚¿ã‚¹ã‚¯ã®è©³ç´°è¨­å®š</h3>
            <div class="field"><label>ã‚¿ã‚¤ãƒˆãƒ«</label><input type="text" id="edit-title"></div>
            <div style="display: flex; flex-direction: column; gap: 5px;">
                <div style="display: flex; gap: 10px;">
                    <div class="field" style="flex: 1;"><label>é–‹å§‹æ—¥</label><input type="date" id="edit-date"></div>
                    <div class="field" style="flex: 1;"><label>çµ‚äº†æ—¥</label><input type="date" id="edit-end-date"></div>
                </div>
                <div class="field">
                    <label>æ™‚åˆ»ï¼ˆå˜ç™ºã‚¿ã‚¹ã‚¯ã®å ´åˆï¼‰</label>
                    <div style="display: flex; gap: 5px;">
                        <input type="time" id="edit-time" step="300" style="flex: 1;">
                        <button type="button" id="clear-time">Ã—</button>
                    </div>
                </div>
            </div>
            <div class="field">
                <label>ãƒ©ãƒ™ãƒ«ã‚«ãƒ©ãƒ¼</label>
                <input type="hidden" id="edit-color">
                <div class="color-palette" id="palette"></div>
            </div>
            <div class="modal-buttons">
                <button class="btn btn-cancel" id="modal-cancel">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
                <button class="btn btn-save" id="modal-save">ä¿å­˜</button>
            </div>
        </div>
    </div>

    <script>
    document.addEventListener('DOMContentLoaded', function() {
        const calendarEl = document.getElementById('calendar');
        const editModal = document.getElementById('edit-modal');
        const paletteContainer = document.getElementById('palette');
        const colorInput = document.getElementById('edit-color');
        const taskInput = document.getElementById('new-task-input');
        const deleteZone = document.getElementById('delete-drop-zone');
        const returnZone = document.getElementById('return-drop-zone');
        const container = document.getElementById('external-events-container');
        const taskArea = document.getElementById('new-task-area');
        const taskTimeInput = document.getElementById('new-task-time');
        let currentEditingId = null;
        let slideDirection = 'right';
        let isSaving = false;
        let isDragging = false;
        let isComposing = false;
        document.addEventListener('compositionstart', () => { isComposing = true; });
        document.addEventListener('compositionend', () => { 
            isComposing = false;
            // å¤‰æ›ç¢ºå®šç›´å¾Œã®EnterãŒä¿å­˜ã«åå¿œã—ãªã„ã‚ˆã†ã€ä¸€ç¬ã ã‘ãƒ©ã‚°ã‚’ä½œã‚‹
            isSaving = true;
            setTimeout(() => { isSaving = false; }, 100);
        });

        // å‰Šé™¤ãƒœã‚¿ãƒ³ã®ãƒˆã‚°ãƒ«å‡¦ç†
        // --- å‰Šé™¤ãƒ»é¸æŠãƒ¢ãƒ¼ãƒ‰ã®åˆ¶å¾¡ ---
        const deleteBtn = document.getElementById('delete-toggle-btn');
        const bulkDeleteBtn = document.getElementById('bulk-delete-btn');

        // ã‚­ãƒ£ãƒ³ã‚»ãƒ«ï¼ˆé€šå¸¸ãƒ¢ãƒ¼ãƒ‰ã«æˆ»ã™ï¼‰é–¢æ•°
        function exitDeleteMode() {
            if (bulkDeleteBtn.style.display === 'none') return;
            deleteBtn.innerText = 'é¸æŠå‰Šé™¤';
            deleteBtn.style.backgroundColor = '';
            bulkDeleteBtn.style.display = 'none';
            document.querySelectorAll('.task-item.selected-for-delete').forEach(el => {
                el.classList.remove('selected-for-delete');
                const cb = el.querySelector('.todo-checkbox');
                if (cb) cb.checked = false;
            });
        }

        // é¸æŠå‰Šé™¤ï¼ˆã¾ãŸã¯å‰Šé™¤å®Ÿè¡Œï¼‰ãƒœã‚¿ãƒ³
        deleteBtn.addEventListener('click', () => {
            const selectedItems = document.querySelectorAll('.task-item.selected-for-delete');
            if (bulkDeleteBtn.style.display === 'none') {
                // ãƒ¢ãƒ¼ãƒ‰é–‹å§‹
                deleteBtn.innerText = '0ä»¶ã‚’å‰Šé™¤';
                deleteBtn.style.backgroundColor = '#FF3B30';
                bulkDeleteBtn.style.display = 'block';
            } else {
                // å®Ÿè¡Œ
                if (selectedItems.length === 0) return alert('å‰Šé™¤ã™ã‚‹ã‚¿ã‚¹ã‚¯ã‚’é¸æŠã—ã¦ãã ã•ã„');
                if (confirm(`${selectedItems.length}ä»¶ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ`)) {
                    const ids = Array.from(selectedItems).map(item => item.dataset.id);
                    Promise.all(ids.map(id => fetch('/delete_task/', {
                        method: 'POST',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify({id})
                    }))).then(() => location.reload());
                }
            }
        });

        // ä¸€æ‹¬å‰Šé™¤ãƒœã‚¿ãƒ³
        bulkDeleteBtn.addEventListener('click', () => {
            if (confirm('TODOãƒªã‚¹ãƒˆã‚’ã™ã¹ã¦å‰Šé™¤ã—ã¦ã‚‚ã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ')) {
                fetch('/delete_all_todo/', { method: 'POST', headers: {'Content-Type': 'application/json'} })
                .then(() => location.reload());
            }
        });

        // ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã‚¨ãƒªã‚¢ã‚¯ãƒªãƒƒã‚¯ãƒ»Escã‚­ãƒ¼ã§ã‚­ãƒ£ãƒ³ã‚»ãƒ«
        calendarEl.addEventListener('click', exitDeleteMode);
        // Escã‚­ãƒ¼ã§ã‚­ãƒ£ãƒ³ã‚»ãƒ«ï¼ˆå‰Šé™¤ãƒ¢ãƒ¼ãƒ‰çµ‚äº† ï¼‹ å…¥åŠ›ã‚¨ãƒªã‚¢ã‚’é–‰ã˜ã‚‹ï¼‰
        document.addEventListener('keydown', (e) => { 
            if (e.key === 'Escape') {
                // 1. é¸æŠå‰Šé™¤ãƒ¢ãƒ¼ãƒ‰ä¸­ãªã‚‰è§£é™¤
                exitDeleteMode();
                
                // 2. ã‚¿ã‚¹ã‚¯å…¥åŠ›ã‚¨ãƒªã‚¢ãŒé–‹ã„ã¦ã„ã‚Œã°é–‰ã˜ã‚‹
                if (taskArea.style.display === 'flex') {
                    taskArea.style.display = 'none';
                    taskTimeInput.style.display = 'none';
                    taskInput.value = ''; // æ–‡å­—ã‚’æ¶ˆã™
                }

                // 3. ç·¨é›†ãƒ¢ãƒ¼ãƒ€ãƒ«ãŒé–‹ã„ã¦ã„ã‚Œã°é–‰ã˜ã‚‹
                if (editModal.style.display === 'block') {
                    calendar.unselect();
                    editModal.style.display = 'none';
                }
            }
        });

        // --- 2. ã‚«ãƒ©ãƒ¼ãƒ‘ãƒ¬ãƒƒãƒˆ ---
        const paletteColors = ["#000000", "#000080", "#00BFFF", "#EA609E", "#F08300", "#00FF00", "#048F51", "#E1AD01", "#FF0000"];
        paletteColors.forEach(color => {
            const chip = document.createElement('div');
            chip.className = 'color-chip';
            chip.style.backgroundColor = color;
            chip.setAttribute('data-color', color.toUpperCase());
            chip.onclick = (e) => {
                e.stopPropagation();
                updatePaletteSelection(color);
            };
            paletteContainer.appendChild(chip);
        });

        // --- 3. ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼åˆæœŸåŒ– ---
        const calendar = new FullCalendar.Calendar(calendarEl, {
            initialView: 'dayGridMonth',
            locale: 'ja',
            // â˜… å·¦å´ã«ã€Œã‚¿ã‚¤ãƒˆãƒ«ã€ã¨ã€ŒTodayã€ã‚’ä¸¦ã¹ã¦é…ç½®
            headerToolbar: {
                left: 'title today', 
                center: '',
                right: ''
            },
            editable: true,
            droppable: true,
            selectable: true, 
            selectMirror: true, 
            unselectAuto: true, 
            dragRevertDuration: 0,
            
            dateClick: (info) => openNewTaskModal(info.dateStr),
            select: (info) => openNewRangeTaskModal(info.startStr, info.endStr),

            eventSources: [
                {
                    events: [
                        {% for task in calendar_tasks %}
                        { 
                            id: '{{ task.id }}', title: '{{ task.title }}', 
                            start: '{{ task.date|date:"Y-m-d" }}{% if task.time %}T{{ task.time|time:"H:i:s" }}{% endif %}', 
                            {% if task.end_date %}end: '{{ task.end_date|date:"Y-m-d" }}',{% endif %}
                            backgroundColor: '{{ task.color }}', borderColor: '{{ task.color }}', 
                            extendedProps: { time: '{{ task.time|time:"H:i" }}' } 
                        },
                        {% endfor %}
                    ]
                },
                {
                    url: 'https://holidays-jp.github.io/api/v1/date.json',
                    format: 'json', color: 'transparent', className: 'holiday-event',
                    success: (data) => Object.keys(data).map(date => ({ title: data[date], start: date, display: 'background' }))
                }
            ],

            eventClick: (info) => openEditModal(info.event),
            eventDragStart: function(info) { 
                [deleteZone, returnZone].forEach(zone => {
                    zone.style.visibility = 'visible';
                    zone.style.opacity = '1';
                    zone.style.pointerEvents = 'auto';
                });
            },
            eventDragStop: function(info) {
                const x = info.jsEvent.clientX;
                const y = info.jsEvent.clientY;

                console.log("ãƒ‰ãƒ­ãƒƒãƒ—åº§æ¨™: ", x, y);
                console.log("å‰Šé™¤ã‚¨ãƒªã‚¢ã®ç¯„å›²: ", deleteZone.getBoundingClientRect());

                // 1. èµ¤æ ï¼ˆå‰Šé™¤ï¼‰ã®åˆ¤å®š
                // visibilityãŒvisibleãªã‚‰ã‚µã‚¤ã‚ºã¯ç¢ºä¿ã•ã‚Œã¦ã„ã‚‹ã®ã§ isInZone ãŒæ­£ã—ãå‹•ãã¾ã™
                if (deleteZone.style.visibility === 'visible' && isInZone(x, y, deleteZone)) {
                    deleteTask(info.event.id);
                }
                
                // 2. é’æ ï¼ˆä¸€è¦§ã«æˆ»ã™ï¼‰ã®åˆ¤å®š
                if (returnZone.style.visibility === 'visible' && isInZone(x, y, returnZone)) {
                    fetch('/remove_task_date/', { 
                        method: 'POST', 
                        headers: {'Content-Type': 'application/json'}, 
                        body: JSON.stringify({id: info.event.id}) 
                    }).then(() => location.reload());
                }

                // ã™ã¹ã¦ã®åˆ¤å®šãŒçµ‚ã‚ã£ã¦ã‹ã‚‰éš ã™
                [deleteZone, returnZone].forEach(zone => {
                    zone.style.visibility = 'hidden';
                    zone.style.opacity = '0';
                    zone.style.pointerEvents = 'none';
                });
            },
            eventReceive: (info) => updateTask(info.event.id, info.event.startStr),
            eventDrop: (info) => updateTask(info.event.id, info.event.startStr),
            eventResize: (info) => updateTaskDuration(info.event),

            datesSet: function() {
                calendarEl.classList.remove('slide-in-left', 'slide-in-right', 'calendar-fade');
                void calendarEl.offsetWidth;
                if (slideDirection === 'right') calendarEl.classList.add('slide-in-right');
                else if (slideDirection === 'left') calendarEl.classList.add('slide-in-left');
                else calendarEl.classList.add('calendar-fade');
                slideDirection = '';
            }
        }); 
        calendar.render();

        window.addEventListener('mouseup', (e) => {
            if (deleteZone.style.display === 'block' && isInZone(e.clientX, e.clientY, deleteZone)) {
                const draggedEl = e.target.closest('.task-item');
                if (draggedEl) {
                    const data = draggedEl.getAttribute('data-event');
                    const eventId = data ? JSON.parse(data).id : draggedEl.getAttribute('data-id');
                    if (eventId) {
                        deleteTask(eventId); // æ‰¿èªãªã—ã§å‰Šé™¤ã‚’å®Ÿè¡Œ
                    }
                }
            }
            // deleteZone.style.display = 'none'; 
            // returnZone.style.display = 'none';
        });

        new FullCalendar.Draggable(container, {
            itemSelector: '.task-item',
            eventData: (el) => JSON.parse(el.getAttribute('data-event'))
        });

        // --- 4. ãƒ¢ãƒ¼ãƒ€ãƒ«åˆ¶å¾¡ ---
        function openNewTaskModal(dateStr) {
            currentEditingId = null;
            document.getElementById('edit-title').value = '';
            document.getElementById('edit-date').value = dateStr;
            document.getElementById('edit-end-date').value = '';
            document.getElementById('edit-time').value = '';
            updatePaletteSelection('#007AFF');
            editModal.style.display = 'block';
            setTimeout(() => document.getElementById('edit-title').focus(), 10);
        }

        // ç¯„å›²æŒ‡å®šã§ã®æ–°è¦ä½œæˆãƒ¢ãƒ¼ãƒ€ãƒ«
        function openNewRangeTaskModal(startStr, endStr) {
            currentEditingId = null;
            document.getElementById('edit-title').value = '';
            document.getElementById('edit-date').value = startStr;
            
            // FullCalendarã®endStrã¯ç¿Œæ—¥ã®00:00ã‚’æŒ‡ã™ãŸã‚ã€è¦‹ãŸç›®ä¸Šã®çµ‚äº†æ—¥ã«èª¿æ•´
            let endDate = new Date(endStr);
            endDate.setDate(endDate.getDate() - 1);
            document.getElementById('edit-end-date').value = endDate.toLocaleDateString('sv');
            
            document.getElementById('edit-time').value = '';
            updatePaletteSelection('#007AFF');
            editModal.style.display = 'block';
            
            setTimeout(() => document.getElementById('edit-title').focus(), 10);
        }

        function openEditModal(eventObj) {
            currentEditingId = eventObj.id;
            document.getElementById('edit-title').value = eventObj.title;
            updatePaletteSelection((eventObj.backgroundColor || '#007AFF').toUpperCase());
            if (eventObj.start) document.getElementById('edit-date').value = eventObj.start.toLocaleDateString('sv');
            document.getElementById('edit-end-date').value = eventObj.end ? eventObj.end.toLocaleDateString('sv') : "";
            document.getElementById('edit-time').value = eventObj.extendedProps.time || "";
            editModal.style.display = 'block';
            setTimeout(() => document.getElementById('edit-title').focus(), 10);
        }

        function updatePaletteSelection(color) {
            colorInput.value = color;
            document.querySelectorAll('.color-chip').forEach(c => c.classList.toggle('selected', c.getAttribute('data-color') === color.toUpperCase()));
        }

        // --- 5. ä¿å­˜ãƒ»å‰Šé™¤ ---
        function submitModalData() {
            const title = document.getElementById('edit-title').value;
            if (!title) { 
                alert('ã‚¿ã‚¤ãƒˆãƒ«ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„'); 
                return; 
            }

            // ã‚µãƒ¼ãƒãƒ¼ã«é€ã‚‹ãƒ‡ãƒ¼ã‚¿
            const payload = {
                id: currentEditingId,
                title: title,
                date: document.getElementById('edit-date').value,
                end_date: document.getElementById('edit-end-date').value,
                time: document.getElementById('edit-time').value,
                color: colorInput.value
            };

            fetch(currentEditingId ? '/edit_task/' : '/add_task/', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify(payload)
            }).then(() => {
                // ä¿å­˜ãŒæˆåŠŸã—ãŸã‚‰ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã®é¸æŠï¼ˆé’ã„æ ï¼‰ã‚’è§£é™¤ã™ã‚‹
                if (typeof calendar !== 'undefined') {
                    calendar.unselect();
                }
                location.reload();
            });
        }

        document.getElementById('modal-save').onclick = submitModalData;
        document.getElementById('modal-cancel').onclick = () => {
            calendar.unselect(); 
            editModal.style.display = 'none';
        };
        document.getElementById('clear-time').onclick = () => document.getElementById('edit-time').value = '';

        // â˜…æ–°è¦ã‚¿ã‚¹ã‚¯ä¿å­˜é–¢æ•°
        function saveNewTask() {
            const val = taskInput.value.trim();
            if (val && !isSaving) {
                isSaving = true;
                fetch('/add_task/', { 
                    method: 'POST', headers: {'Content-Type': 'application/json'}, 
                    body: JSON.stringify({title: val, time: taskTimeInput.value})
                }).then(() => location.reload());
            } else {
                // åå‰ãŒç©ºã€ã¾ãŸã¯ä¿å­˜ä¸è¦ãªå ´åˆã¯ã‚¨ãƒªã‚¢ã‚’éš ã™
                taskArea.style.display = 'none'; 
                taskTimeInput.style.display = 'none';
                taskInput.value = '';
            }
        }

        // ãƒ¢ãƒ¼ãƒ€ãƒ«å†…ã®Tabã‚­ãƒ¼åˆ¶å¾¡ï¼ˆè§£æ±ºç­–2ï¼‰
        document.getElementById('edit-title').addEventListener('keydown', (e) => {
            if (isComposing) return; // å¤‰æ›ä¸­ã¯ä½•ã‚‚ã•ã›ãªã„
            
            if (e.key === 'Tab') { 
                e.preventDefault(); 
                document.getElementById('edit-time').focus(); 
            }
            if (e.key === 'Enter') {
                e.preventDefault();
                submitModalData();
            }
        });

        // --- 6. ã‚¯ãƒªãƒƒã‚¯ã‚¤ãƒ™ãƒ³ãƒˆï¼ˆé¸æŠãƒ»ç·¨é›†ãƒ»ãƒ•ã‚©ãƒ¼ãƒ è¡¨ç¤ºï¼‰ ---
        container.addEventListener('click', (e) => {
            // ãƒ‰ãƒ©ãƒƒã‚°æ“ä½œï¼ˆé•·æŠ¼ã—å«ã‚€ï¼‰ã®ç›´å¾Œã¯ã‚¯ãƒªãƒƒã‚¯å‡¦ç†ã‚’å®Œå…¨ã«ç„¡è¦–ã™ã‚‹
            if (isDragging) return;

            const item = e.target.closest('.task-item');
            
            // ã‚¿ã‚¹ã‚¯ä»¥å¤–ã®å ´æ‰€ï¼ˆä½™ç™½ï¼‰ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ãŸæ™‚
            if (!item) {
                // é¸æŠå‰Šé™¤ãƒ¢ãƒ¼ãƒ‰ä¸­ãªã‚‰ãƒ•ã‚©ãƒ¼ãƒ ã¯å‡ºã•ãªã„
                if (bulkDeleteBtn.style.display === 'block') return;

                if (e.target.id !== 'new-task-input' && e.target.id !== 'new-task-time') {
                    taskArea.style.display = 'flex'; 
                    taskInput.focus();
                }
                return;
            }

            e.stopPropagation();

            // é¸æŠãƒ¢ãƒ¼ãƒ‰ä¸­ã®ã‚¯ãƒªãƒƒã‚¯å‡¦ç†
            if (bulkDeleteBtn.style.display === 'block') {
                item.classList.toggle('selected-for-delete');
                const checkbox = item.querySelector('.todo-checkbox');
                if (checkbox) checkbox.checked = item.classList.contains('selected-for-delete');
                
                const count = document.querySelectorAll('.task-item.selected-for-delete').length;
                deleteBtn.innerText = `${count}ä»¶ã‚’å‰Šé™¤`;
                return; 
            }

            // é€šå¸¸ãƒ¢ãƒ¼ãƒ‰æ™‚ã®ã‚¯ãƒªãƒƒã‚¯å‡¦ç†ï¼šç·¨é›†ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‹ã
            const eventData = JSON.parse(item.getAttribute('data-event'));
            openEditModal(calendar.getEventById(eventData.id) || { 
                id: eventData.id, 
                title: eventData.title, 
                backgroundColor: eventData.color, 
                extendedProps: { time: eventData.time }, 
                start: null, end: null 
            });
        });

        // ãƒ•ã‚©ãƒ¼ãƒ å¤–ã‚¯ãƒªãƒƒã‚¯ã§ä¿å­˜
        taskInput.addEventListener('blur', () => setTimeout(() => { if (!isSaving && document.activeElement !== taskTimeInput) saveNewTask(); }, 150));
        taskTimeInput.addEventListener('blur', () => setTimeout(() => { if (!isSaving && document.activeElement !== taskInput) saveNewTask(); }, 150));

        taskInput.addEventListener('keydown', (e) => {
            if (isComposing) return;
            if (e.key === 'Tab' && taskInput.value.trim() !== "") { e.preventDefault(); taskTimeInput.style.display = 'block'; taskTimeInput.focus(); }
            else if (e.key === 'Enter') saveNewTask();
        });
        taskTimeInput.addEventListener('keydown', (e) => { if (e.key === 'Enter') saveNewTask(); });

        // --- 7. ãƒ‰ãƒ©ãƒƒã‚°ï¼†ãƒ‰ãƒ­ãƒƒãƒ—å‰Šé™¤ã¨é•·æŠ¼ã—åˆ¶å¾¡ ---
        
        // ãƒã‚¦ã‚¹ã‚’æŠ¼ã—ãŸæ™‚
        container.addEventListener('mousedown', (e) => { 
            const item = e.target.closest('.task-item');
            if (!item) return;

            isDragging = false;
            // é¸æŠãƒ¢ãƒ¼ãƒ‰ä¸­ã§ãªã„æ™‚ã ã‘ã€ãƒ‰ãƒ©ãƒƒã‚°æº–å‚™ï¼ˆæ ã®è¡¨ç¤ºï¼‰ã‚’è¨±å¯
            if (bulkDeleteBtn.style.display === 'none') {
                // å°‘ã—ã§ã‚‚ãƒã‚¦ã‚¹ã‚’å‹•ã‹ã—ãŸã‚‰ãƒ‰ãƒ©ãƒƒã‚°ä¸­ã¨ã¿ãªã™ãŸã‚ã®æº–å‚™
                const startX = e.clientX;
                const startY = e.clientY;

                const moveHandler = (me) => {
                    // 5ãƒ”ã‚¯ã‚»ãƒ«ä»¥ä¸Šå‹•ã„ãŸã‚‰ã€Œãƒ‰ãƒ©ãƒƒã‚°ä¸­ã€ã¨åˆ¤å®šã—æ ã‚’å‡ºã™
                    if (Math.abs(me.clientX - startX) > 5 || Math.abs(me.clientY - startY) > 5) {
                        isDragging = true;
                        deleteZone.style.display = 'block';
                    }
                };

                const upHandler = () => {
                    window.removeEventListener('mousemove', moveHandler);
                    window.removeEventListener('mouseup', upHandler);
                };

                window.addEventListener('mousemove', moveHandler);
                window.addEventListener('mouseup', upHandler);
            } else {
                // é¸æŠãƒ¢ãƒ¼ãƒ‰ä¸­ã®æ™‚ã¯ã€é•·æŠ¼ã—ã—ã¦ã‚‚ click ã‚¤ãƒ™ãƒ³ãƒˆã‚’æ®ºã•ãªã„ã‚ˆã†ã«
                // å˜ç´”ã«ä¸€å®šæ™‚é–“çµŒéã§ isDragging ã‚’ true ã«ã™ã‚‹ã ã‘ã®å‡¦ç†ã«ã™ã‚‹
                setTimeout(() => { 
                    if (e.buttons === 1) isDragging = true; 
                }, 300);
            }
        });


        // è£œåŠ©é–¢æ•°
        function isInZone(x, y, zone) { 
            const r = zone.getBoundingClientRect();
            // ãƒã‚¦ã‚¹ã®åº§æ¨™ãŒã€æ ã®ã€Œå·¦ç«¯ã€œå³ç«¯ã€ã‹ã¤ã€Œä¸Šç«¯ã€œä¸‹ç«¯ã€ã®é–“ã«ã‚ã‚‹ã‹
            return (
                x >= r.left && 
                x <= r.right && 
                y >= r.top && 
                y <= r.bottom
            );
        }
        function updateTask(id, start) { fetch('/update_task_date/', { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({id, start}) }).then(() => location.reload()); }
        function deleteTask(id) { fetch('/delete_task/', { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({id}) }).then(() => location.reload()); }
        function updateTaskDuration(event) { 
            fetch('/update_task_duration/', { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({id: event.id, start: event.startStr, end: event.endStr}) }).then(() => location.reload());
        }

        // --- 8. å…¨ä½“æ“ä½œ ---
        document.addEventListener('keydown', (e) => {
            const activeEl = document.activeElement.tagName.toLowerCase();
            if (editModal.style.display === 'block' || activeEl === 'input' || activeEl === 'textarea') return;

            if (e.code === 'Space'|| e.key === ' ') {
                e.preventDefault();
                taskArea.style.display = 'flex';
                taskInput.focus();
            }
            if (e.key === '0' || e.code === 'Numpad0') {
                e.preventDefault();
                slideDirection = ''; 
                calendar.today();
            }
            if (e.key === 'ArrowLeft') { slideDirection = 'left'; calendar.prev(); }
            else if (e.key === 'ArrowRight') { slideDirection = 'right'; calendar.next(); }
        });

        let isScrolling = false;
        calendarEl.addEventListener('wheel', (e) => {
            if (Math.abs(e.deltaX) < Math.abs(e.deltaY)) return; 
            e.preventDefault();
            if (isScrolling) return;
            if (e.deltaX < -10) {
                isScrolling = true; slideDirection = 'left'; calendar.prev();
            } else if (e.deltaX > 10) {
                isScrolling = true; slideDirection = 'right'; calendar.next();
            }
            if (isScrolling) setTimeout(() => { isScrolling = false; }, 500);
        }, { passive: false });
    });
    </script>
</body>
</html>